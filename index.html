<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ingliz–O‘zbek Lug‘at</title>
  <style>
    :root{--accent:#0b76d1}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f7fafc;color:#0b1220}
    header{background:linear-gradient(90deg,var(--accent),#036);color:white;padding:20px}
    .container{max-width:980px;margin:18px auto;padding:0 16px}
    h1[contenteditable]{display:inline-block;margin:0;padding:6px 10px;border-radius:6px;min-width:220px}
    .meta{color:#e6efff;font-size:14px;margin-top:8px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:white;cursor:pointer}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    input[type=text], textarea, select{padding:8px;border:1px solid #d1d5db;border-radius:8px}
    .form-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:12px;background:white;border-radius:8px;overflow:hidden;box-shadow:0 1px 0 rgba(2,6,23,0.04)}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;vertical-align:middle}
    th{background:#f1f5f9;font-weight:600}
    tr:hover{background:#f8fbff}
    td img.row-thumb{width:48px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #e6eef8}
    .small{font-size:13px;color:#475569}
    .muted{color:#6b7280;font-size:13px}
    .inline-edit{background:transparent;border:none;padding:4px;border-radius:6px;min-width:80px}
    .file-input{display:none}
    .actions button{margin-right:6px}
    footer{margin:30px 0 60px;color:#6b7280;font-size:14px;text-align:center}
    @media (max-width:720px){th,td{padding:8px;font-size:14px}}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 id="siteTitle" contenteditable="true" title="Sahifa nomini tahrirlash mumkin">Ingliz–Oʻzbek Lugʻat</h1>
      <div class="meta small">Sarlavhani ustiga bosib nomini o‘zgartiring. O‘zgartirishlar brauzeringizda avtomatik saqlanadi.</div>
    </div>
  </header>

  <main class="container">
    <div class="controls">
      <input id="search" type="text" placeholder="Qidirish — inglizcha yoki o'zbekcha..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #d1d5db">
      <button class="btn" id="clearSearch">Tozalash</button>

      <label class="chip" for="csvImport">CSV import</label>
      <input id="csvImport" class="file-input" type="file" accept=".csv,text/csv">

      <label class="chip" for="jsonImport">JSON import</label>
      <input id="jsonImport" class="file-input" type="file" accept=".json,application/json">

      <button class="chip" id="exportCsv">CSV export</button>
      <button class="chip" id="exportJson">JSON export</button>
      <button class="chip" id="resetAll" title="Barcha soʻzlarni va sozlamalarni o‘chiradi">Reset</button>
    </div>

    <details open>
      <summary class="small muted">Yangi yozuv qo'shish</summary>
      <div style="margin-top:10px;padding:10px;border-radius:8px;background:#fff">
        <div class="form-row">
          <input id="newEnglish" type="text" placeholder="Inglizcha (English)" style="flex:1">
          <input id="newUzbek" type="text" placeholder="Oʻzbekcha (Uzbek)" style="flex:1">
          <label class="chip" for="newImage">Rasm</label>
          <input id="newImage" class="file-input" type="file" accept="image/*">
          <button class="btn" id="addRow">Qo'shish</button>
        </div>
        <div id="newPreview" style="margin-top:8px"></div>
      </div>
    </details>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
      <div class="small">Natijalar: <span id="count">0</span></div>
      <div class="small muted">Saqlangan: <span id="savedAt">—</span></div>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:48px">#</th>
          <th style="width:64px">Rasm</th>
          <th>Inglizcha</th>
          <th>Oʻzbekcha</th>
          <th style="width:160px">Harakatlar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="small muted" style="margin-top:12px">
      CSV uchun ustunlar: <code>n,english,uzbek,imageDataUrl</code>.
    </p>
  </main>

  <footer>
    &copy; <span id="year"></span> — Sizning lugʻatingiz. Lokalda saqlanadi (localStorage).
  </footer>

  <script>
    // --- boshlang'ich ma'lumot ---
    const SAMPLE = [
      {n:1, english:'apple', uzbek:'olma', image:''},
      {n:2, english:'book', uzbek:'kitob', image:''},
      {n:3, english:'chair', uzbek:'stul', image:''}
    ];

    // --- elementlar ---
    const tblBody = document.querySelector('#tbl tbody');
    const countEl = document.getElementById('count');
    const savedAt = document.getElementById('savedAt');
    const siteTitle = document.getElementById('siteTitle');
    const yearEl = document.getElementById('year');

    const searchInput = document.getElementById('search');
    const clearSearch = document.getElementById('clearSearch');

    const newEnglish = document.getElementById('newEnglish');
    const newUzbek = document.getElementById('newUzbek');
    const newImage = document.getElementById('newImage');
    const newPreview = document.getElementById('newPreview');
    const addRowBtn = document.getElementById('addRow');

    const csvImport = document.getElementById('csvImport');
    const jsonImport = document.getElementById('jsonImport');
    const exportCsv = document.getElementById('exportCsv');
    const exportJson = document.getElementById('exportJson');
    const resetAll = document.getElementById('resetAll');

    // --- state ---
    let data = [];
    const STORAGE_KEY = 'my_engl_uzb_dict_v2';
    const TITLE_KEY = 'my_engl_uzb_dict_title_v2';

    // --- utilities ---
    function escapeHTML(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
    function nowTs(){ return new Date().toISOString(); }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({data, saved: nowTs()})); savedAt.textContent = new Date().toLocaleString(); }
    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){ try{ const obj = JSON.parse(raw); data = obj.data || []; savedAt.textContent = obj.saved? new Date(obj.saved).toLocaleString() : '—'; return; }catch(e){} }
      // default
      data = SAMPLE.slice();
      save();
    }

    // --- render ---
    function render(list){
      tblBody.innerHTML = '';
      list.forEach((item, idx)=>{
        const tr = document.createElement('tr');

        const imgCell = item.image ? `<img class="row-thumb" src="${item.image}" alt="">` : `<div class="muted small">—</div>`;

        tr.innerHTML = `
          <td>${item.n || idx+1}</td>
          <td>${imgCell}</td>
          <td><input class="inline-edit" data-field="english" value="${escapeHTML(item.english||'')}" /></td>
          <td><input class="inline-edit" data-field="uzbek" value="${escapeHTML(item.uzbek||'')}" /></td>
          <td class="actions">
            <button class="chip" data-action="change-img">Rasm</button>
            <button class="chip" data-action="save-row">Saqlash</button>
            <button class="chip" data-action="delete-row">O'chirish</button>
            <button class="chip" data-action="move-up" title="Yuqoriga">↑</button>
            <button class="chip" data-action="move-down" title="Quyiga">↓</button>
          </td>
        `;
        // attach index
        tr.querySelectorAll('input.inline-edit').forEach(inp=>{
          inp.addEventListener('change', ()=> {
            const field = inp.dataset.field;
            item[field] = inp.value;
            save();
            updateCount();
          });
        });

        // action handlers
        tr.querySelector('[data-action="change-img"]').addEventListener('click', ()=>{
          const f = document.createElement('input');
          f.type='file'; f.accept='image/*';
          f.addEventListener('change', e=>{
            const file = e.target.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = ()=> {
              item.image = r.result;
              save();
              render(filteredData()); // re-render to update thumb
            };
            r.readAsDataURL(file);
          });
          f.click();
        });

        tr.querySelector('[data-action="save-row"]').addEventListener('click', ()=>{
          save();
          render(filteredData());
        });

        tr.querySelector('[data-action="delete-row"]').addEventListener('click', ()=>{
          if(!confirm('Ushbu yozuvni oʻchirilsinmi?')) return;
          data = data.filter(d=>d !== item);
          data.forEach((d,i)=>d.n = i+1);
          save();
          render(filteredData());
        });

        tr.querySelector('[data-action="move-up"]').addEventListener('click', ()=>{
          const i = data.indexOf(item);
          if(i>0){ data.splice(i,1); data.splice(i-1,0,item); data.forEach((d,idx)=>d.n = idx+1); save(); render(filteredData()); }
        });
        tr.querySelector('[data-action="move-down"]').addEventListener('click', ()=>{
          const i = data.indexOf(item);
          if(i < data.length-1){ data.splice(i,1); data.splice(i+1,0,item); data.forEach((d,idx)=>d.n = idx+1); save(); render(filteredData()); }
        });

        tblBody.appendChild(tr);
      });
      updateCount();
    }

    function updateCount(){
      const cnt = filteredData().length;
      countEl.textContent = cnt;
    }

    // --- adding new row ---
    newImage.addEventListener('change', (e)=>{
      const file = e.target.files[0];
      newPreview.innerHTML = '';
      if(!file) return;
      const r = new FileReader();
      r.onload = ()=> {
        const img = document.createElement('img');
        img.src = r.result; img.style.maxWidth='120px'; img.style.borderRadius='8px';
        newPreview.appendChild(img);
      };
      r.readAsDataURL(file);
    });

    addRowBtn.addEventListener('click', ()=>{
      const eng = newEnglish.value.trim();
      const uz = newUzbek.value.trim();
      if(!eng && !uz){ alert('Inglizcha yoki o‘zbekcha maydonlardan kamida bittasini to‘ldiring'); return; }
      const entry = {
        n: data.length + 1,
        english: eng,
        uzbek: uz,
        image: ''
      };
      const file = newImage.files[0];
      if(file){
        const r = new FileReader();
        r.onload = ()=>{
          entry.image = r.result;
          data.push(entry);
          save();
          clearNewForm();
          render(filteredData());
        };
        r.readAsDataURL(file);
      } else {
        data.push(entry);
        save();
        clearNewForm();
        render(filteredData());
      }
    });

    function clearNewForm(){
      newEnglish.value=''; newUzbek.value=''; newImage.value=''; newPreview.innerHTML='';
    }

    // --- search/filter ---
    function filteredData(){
      const q = (searchInput.value||'').trim().toLowerCase();
      if(!q) return data.slice();
      return data.filter(d=>{
        return (d.english||'').toLowerCase().includes(q) ||
               (d.uzbek||'').toLowerCase().includes(q) ||
               (d.n||'').toString().includes(q);
      });
    }

    searchInput.addEventListener('input', ()=> render(filteredData()));
    clearSearch.addEventListener('click', ()=> { searchInput.value=''; render(filteredData()); });

    // --- import/export CSV & JSON ---
    function toCSV(arr){
      // CSV columns: n,english,uzbek,imageDataUrl
      const rows = arr.map(r=>[r.n, r.english, r.uzbek, r.image||''].map(v=> `"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
      return ['n,english,uzbek,imageDataUrl', ...rows].join('\n');
    }

    exportCsv.addEventListener('click', ()=>{
      const csv = toCSV(data);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='dictionary.csv'; a.click(); URL.revokeObjectURL(url);
    });

    exportJson.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({data, title: siteTitle.textContent},null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='dictionary.json'; a.click(); URL.revokeObjectURL(url);
    });

    csvImport.addEventListener('change', e=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        const txt = r.result;
        const lines = txt.split(/\r?\n/).filter(l=>l.trim());
        // detect header and map columns
        const header = lines.shift().split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(h=>h.trim().replace(/^"|"$/g,'').toLowerCase());
        const parsed = lines.map((line, idx)=>{
          const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,''));
          const obj = { n: idx+1, english:'', uzbek:'', image:'' };
          header.forEach((h,i)=>{
            if(h.includes('n')) obj.n = Number(cols[i]) || obj.n;
            else if(h.includes('english')||h.includes('ingliz')) obj.english = cols[i]||'';
            else if(h.includes('uzbek')||h.includes('o\'zbek')||h.includes('ozbek')) obj.uzbek = cols[i]||'';
            else if(h.includes('image')||h.includes('imagedataurl')) obj.image = cols[i]||'';
          });
          return obj;
        });
        data = parsed;
        data.forEach((d,i)=>d.n = i+1);
        save();
        render(filteredData());
        csvImport.value='';
      };
      r.readAsText(f,'utf-8');
    });

    jsonImport.addEventListener('change', e=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const obj = JSON.parse(r.result);
          if(obj.data && Array.isArray(obj.data)) data = obj.data;
          else if(Array.isArray(obj)) data = obj;
          else throw new Error('JSON format noto‘g‘ri');
          data.forEach((d,i)=>d.n = d.n || i+1);
          save();
          render(filteredData());
        }catch(err){ alert('JSON import xatosi: '+err.message); }
        jsonImport.value='';
      };
      r.readAsText(f,'utf-8');
    });

    // --- reset ---
    resetAll.addEventListener('click', ()=>{
      if(!confirm('Barcha maʼlumotlar o‘chiriladi. Davom etilsinmi?')) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(TITLE_KEY);
      load();
      siteTitle.textContent = 'Ingliz–Oʻzbek Lugʻat';
      render(filteredData());
    });

    // --- title save/load ---
    siteTitle.addEventListener('input', ()=> { localStorage.setItem(TITLE_KEY, siteTitle.textContent); });
    function loadTitle(){ const t = localStorage.getItem(TITLE_KEY); if(t) siteTitle.textContent = t; }

    // --- init ---
    function init(){
      yearEl.textContent = new Date().getFullYear();
      loadTitle();
      load();
      render(filteredData());
    }
    init();

    // keyboard: Ctrl+S to export JSON
    window.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); exportJson.click(); }
    });
  </script>
</body>
</html>
